<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.82.0"><meta name=description content="Tutorial website for FXGL"><meta name=author content="Mazela-Man"><link rel=icon href=/mazela-man-web/assets/favicon.ico type=image/ico><title>07. Bonus Points - Mazela-Man FXGL Tutorial</title><link href=/mazela-man-web/css/nucleus.css?1617214317 rel=stylesheet><link href=/mazela-man-web/css/fontawesome-all.min.css?1617214317 rel=stylesheet><link href=/mazela-man-web/css/hybrid.css?1617214317 rel=stylesheet><link href=/mazela-man-web/css/featherlight.min.css?1617214317 rel=stylesheet><link href=/mazela-man-web/css/perfect-scrollbar.min.css?1617214317 rel=stylesheet><link href=/mazela-man-web/css/auto-complete.css?1617214317 rel=stylesheet><link href=/mazela-man-web/css/atom-one-dark-reasonable.css?1617214317 rel=stylesheet><link href=/mazela-man-web/css/theme.css?1617214317 rel=stylesheet><link href=/mazela-man-web/css/hugo-theme.css?1617214317 rel=stylesheet><link href=/mazela-man-web/css/theme-red.css?1617214317 rel=stylesheet><script src=/mazela-man-web/js/jquery-3.3.1.min.js?1617214317></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/mazela-man-web/07_bonus_points/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=https://dykstrom.github.io/mazela-man-web/home/><img src=https://dykstrom.github.io/mazela-man-web/images/07/cherries-live.png></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/mazela-man-web/js/lunr.min.js?1617214317></script><script type=text/javascript src=/mazela-man-web/js/auto-complete.js?1617214317></script><script type=text/javascript>var baseurl="https://dykstrom.github.io/mazela-man-web/"</script><script type=text/javascript src=/mazela-man-web/js/search.js?1617214317></script></div><div class=highlightable><ul class=topics><li data-nav-id=/mazela-man-web/home/ title=Mazela-Man class=dd-item><a href=/mazela-man-web/home/>Mazela-Man</a></li><li data-nav-id=/mazela-man-web/introduction/ title=Introduction class=dd-item><a href=/mazela-man-web/introduction/>Introduction</a></li><li data-nav-id=/mazela-man-web/01_handling_input/ title="01. Handling input" class=dd-item><a href=/mazela-man-web/01_handling_input/>01. Handling input</a></li><li data-nav-id=/mazela-man-web/02_physics/ title="02. Physics" class=dd-item><a href=/mazela-man-web/02_physics/>02. Physics</a></li><li data-nav-id=/mazela-man-web/03_eating_and_keeping_score/ title="03. Eating and Keeping Score" class=dd-item><a href=/mazela-man-web/03_eating_and_keeping_score/>03. Eating and Keeping Score</a></li><li data-nav-id=/mazela-man-web/04_animation/ title="04. Animation" class=dd-item><a href=/mazela-man-web/04_animation/>04. Animation</a></li><li data-nav-id=/mazela-man-web/05_adding_enemies/ title="05. Adding Enemies" class=dd-item><a href=/mazela-man-web/05_adding_enemies/>05. Adding Enemies</a></li><li data-nav-id=/mazela-man-web/06_second_level/ title="06. A Second Level" class=dd-item><a href=/mazela-man-web/06_second_level/>06. A Second Level</a></li><li data-nav-id=/mazela-man-web/07_bonus_points/ title="07. Bonus Points" class="dd-item
parent
active"><a href=/mazela-man-web/07_bonus_points/>07. Bonus Points</a></li><li data-nav-id=/mazela-man-web/08_adding_sound/ title="08. Adding Sound" class=dd-item><a href=/mazela-man-web/08_adding_sound/>08. Adding Sound</a></li><li data-nav-id=/mazela-man-web/09_enable_main_menu/ title="09. Enable Main Menu" class=dd-item><a href=/mazela-man-web/09_enable_main_menu/>09. Enable Main Menu</a></li><li data-nav-id=/mazela-man-web/10_end_of_tutorial/ title="10. End of Tutorial" class=dd-item><a href=/mazela-man-web/10_end_of_tutorial/>10. End of Tutorial</a></li></ul><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=/mazela-man-web/>Home</a> > 07. Bonus Points</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#adding-cherries-in-tiled>Adding Cherries in Tiled</a></li><li><a href=#entity-factory>Entity Factory</a></li><li><a href=#cherryspawncomponent>CherrySpawnComponent</a></li><li><a href=#collision-handling>Collision Handling</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>07. Bonus Points</h1><p>In this chapter we will add cherries that enable the player to earn bonus points. The
cherries will spawn at well-defined spawn-points at random points in time, and remain
visible for ten seconds before they disappear.</p><h3 id=adding-cherries-in-tiled>Adding Cherries in Tiled</h3><p>As usual, we start in Tiled. This time, you need to edit both level 1 and level 2, and
any additional levels you may have created. Or you can copy the level files from the
<a href=https://dykstrom.github.io/mazela-man-web/08_adding_sound/>next chapter</a>. We will not add any
cherries, but rather cherry spawn-points to the level files. The spawn-points will
exist through the whole level even though the spawned cherries will not. I added
spawn-points in the corners of the level 1 maze, and set the type string to
&ldquo;CherrySpawnPoint&rdquo;.</p><p><img src=https://dykstrom.github.io/mazela-man-web/images/07/cherry-spawn-points.png alt="Cherry Spawn Points"></p><p>We also need to copy the <a href=https://dykstrom.github.io/mazela-man-web/resources/cherry.png>cherry image</a> to the textures folder.</p><h3 id=entity-factory>Entity Factory</h3><p>The next step is as always to create a new spawn method for the object we added to the
level file. In this case we will actually add two spawn methods - one for the cherry
spawn-point, and one for the cherries.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@Spawns</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CherrySpawnPoint&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> Entity <span style=color:#a6e22e>spawnCherrySpawnPoint</span><span style=color:#f92672>(</span>SpawnData data<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> FXGL<span style=color:#f92672>.</span><span style=color:#a6e22e>entityBuilder</span><span style=color:#f92672>(</span>data<span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>with</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CherrySpawnComponent<span style=color:#f92672>())</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Spawns</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cherry&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> Entity <span style=color:#a6e22e>spawnCherry</span><span style=color:#f92672>(</span>SpawnData data<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> FXGL<span style=color:#f92672>.</span><span style=color:#a6e22e>entityBuilder</span><span style=color:#f92672>(</span>data<span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>(</span>EntityType<span style=color:#f92672>.</span><span style=color:#a6e22e>CHERRY</span><span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>viewWithBBox</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;cherry.png&#34;</span><span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>collidable</span><span style=color:#f92672>()</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>The cherry spawn-point is an invisible entity, so it does not have any view. The only
thing it <em>does</em> have is a <code>CherrySpawnComponent</code>, which we will create shortly. The
cherries are collidable entities with a view, and a bounding box created from the view.
The cherries are of entity type <code>CHERRY</code> to enable them to be picked up by the player.
The <code>EntityType</code> enum constant <code>CHERRY</code> must also be created.</p><h3 id=cherryspawncomponent>CherrySpawnComponent</h3><p>Here is the entire <code>CherrySpawnComponent</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CherrySpawnComponent</span> <span style=color:#66d9ef>extends</span> Component <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Random RANDOM <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Random<span style=color:#f92672>();</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onUpdate</span><span style=color:#f92672>(</span><span style=color:#66d9ef>double</span> tpf<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// Spawn a cherry randomly if there is not a cherry already
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>RANDOM<span style=color:#f92672>.</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>(</span>1000<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0 <span style=color:#f92672>&amp;&amp;</span> noCherryAt<span style=color:#f92672>(</span>entity<span style=color:#f92672>.</span><span style=color:#a6e22e>getX</span><span style=color:#f92672>(),</span> entity<span style=color:#f92672>.</span><span style=color:#a6e22e>getY</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
            Entity cherry <span style=color:#f92672>=</span> FXGL<span style=color:#f92672>.</span><span style=color:#a6e22e>spawn</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cherry&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> SpawnData<span style=color:#f92672>(</span>entity<span style=color:#f92672>.</span><span style=color:#a6e22e>getX</span><span style=color:#f92672>(),</span> entity<span style=color:#f92672>.</span><span style=color:#a6e22e>getY</span><span style=color:#f92672>()));</span>
            despawnLater<span style=color:#f92672>(</span>cherry<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>despawnLater</span><span style=color:#f92672>(</span>Entity cherry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        FXGL<span style=color:#f92672>.</span><span style=color:#a6e22e>getGameTimer</span><span style=color:#f92672>().</span><span style=color:#a6e22e>runOnceAfter</span><span style=color:#f92672>(</span>cherry<span style=color:#f92672>::</span>removeFromWorld<span style=color:#f92672>,</span> Duration<span style=color:#f92672>.</span><span style=color:#a6e22e>seconds</span><span style=color:#f92672>(</span>10<span style=color:#f92672>));</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>noCherryAt</span><span style=color:#f92672>(</span><span style=color:#66d9ef>double</span> x<span style=color:#f92672>,</span> <span style=color:#66d9ef>double</span> y<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> FXGL<span style=color:#f92672>.</span><span style=color:#a6e22e>getGameWorld</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getEntitiesByType</span><span style=color:#f92672>(</span>EntityType<span style=color:#f92672>.</span><span style=color:#a6e22e>CHERRY</span><span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>stream</span><span style=color:#f92672>()</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>noneMatch</span><span style=color:#f92672>(</span>e <span style=color:#f92672>-&gt;</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getX</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> x <span style=color:#f92672>&amp;&amp;</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getY</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> y<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>The <code>CherrySpawnComponent</code> has an <code>onUpdate</code> method that is called every frame. Every
time that method is called, there is one chance in 1000 to spawn a cherry, if there is
not already a cherry at that position. Note that the component does not need to remember
its own position, because it has access to the entity it is part of, and the entity has
the position.</p><p>If we are lucky, and a cherry should be spawned, <code>onUpdate</code> calls one of the <code>spawn</code>
methods in <code>FXGL</code>, which in turn uses some reflection magic to call the <code>spawnCherry</code>
method in our entity factory. We get back a reference to the created entity, and this
reference is passed to a method that starts a timer that triggers after 10 seconds, and
then removes the cherry again.</p><p>Using the built-in game timer has the advantage that the call to <code>removeFromWorld</code> is
performed on the JavaFX Application Thread. JavaFX and FXGL require all calls to the
framework to be made on the JavaFX Application Thread to work properly. Normally, that
is no problem because all callback methods are called on this thread, but creating your
own timer would involve a background thread.</p><p>The helper method <code>noCherryAt</code> just checks that there is no entity of type <code>CHERRY</code> at
the specified position. An alternative implementation of this method could have retrieved
all entities at the specified position using <code>getEntitiesAt</code> and then checked that none
of them was of type <code>CHERRY</code>.</p><h3 id=collision-handling>Collision Handling</h3><p>The player-cherry collision handler is very straight forward, and I almost feel it
unnecessary to state it here, but anyway, here it is:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    physics<span style=color:#f92672>.</span><span style=color:#a6e22e>addCollisionHandler</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CollisionHandler<span style=color:#f92672>(</span>EntityType<span style=color:#f92672>.</span><span style=color:#a6e22e>PLAYER</span><span style=color:#f92672>,</span> EntityType<span style=color:#f92672>.</span><span style=color:#a6e22e>CHERRY</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#a6e22e>@Override</span>
        <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onCollisionBegin</span><span style=color:#f92672>(</span>Entity player<span style=color:#f92672>,</span> Entity cherry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            cherry<span style=color:#f92672>.</span><span style=color:#a6e22e>removeFromWorld</span><span style=color:#f92672>();</span>
            FXGL<span style=color:#f92672>.</span><span style=color:#a6e22e>inc</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;score&#34;</span><span style=color:#f92672>,</span> 100<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>});</span>
</code></pre></div><p><img src=https://dykstrom.github.io/mazela-man-web/images/07/cherries-live.png alt="Game with Cherries"></p><p>This completes this chapter. Move on to the <a href=https://dykstrom.github.io/mazela-man-web/08_adding_sound/>next chapter</a>
where we will add sound to the game.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/mazela-man-web/06_second_level/ title="06. A Second Level"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/mazela-man-web/08_adding_sound/ title="08. Adding Sound" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/mazela-man-web/js/clipboard.min.js?1617214317></script><script src=/mazela-man-web/js/perfect-scrollbar.min.js?1617214317></script><script src=/mazela-man-web/js/perfect-scrollbar.jquery.min.js?1617214317></script><script src=/mazela-man-web/js/jquery.sticky.js?1617214317></script><script src=/mazela-man-web/js/featherlight.min.js?1617214317></script><script src=/mazela-man-web/js/highlight.pack.js?1617214317></script><script>hljs.initHighlightingOnLoad()</script><script src=/mazela-man-web/js/modernizr.custom-3.6.0.js?1617214317></script><script src=/mazela-man-web/js/learn.js?1617214317></script><script src=/mazela-man-web/js/hugo-learn.js?1617214317></script><script src=/mazela-man-web/mermaid/mermaid.js?1617214317></script><script>mermaid.initialize({startOnLoad:!0})</script></body></html>